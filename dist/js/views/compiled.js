define(["backbone","underscore","jquery","vent","marked"],function(e,t,n,r,i){function o(e){return s[e]||e}function u(e){return e.replace(/[&<>]/g,o)}var s={"<":"&lt;",">":"&gt;"};return e.View.extend({el:"#compiled",mdWrapper:'<div class="compiled github" />',rmWrapper:'<iframe class="remark-preview" />',initialize:function(){i.setOptions({gfm:!0,tables:!0,breaks:!0,pedantic:!1,sanitize:!0,smartLists:!0,langPrefix:"language-"}),this.$el.find(".compiled").hide(),r.on("compiled:render",this.setOutput,this)},setOutput:function(e,t){if(e.get("remark"))return this.setRemark(e,t);this.$el.find(".weak-text").remove();var r=this.$el.find(".compiled");r.length||(r=n(this.mdWrapper).appendTo(this.$el),this.$el.find(".remark-preview").remove());var s=typeof t=="string"?t:t.get("body"),o=i(s);r.html(o).show()},setRemark:function(e,t){this.$el.find(".weak-text").remove();var r=this.$el.find(".remark-preview");r.length?this.refreshIFrame(r[0],e,t):(r=n(this.rmWrapper).attr("src","/document/"+e.get("_id")).appendTo(this.$el),this.$el.find(".compiled").remove())},refreshIFrame:function(e,t,r){var i=typeof r=="string"?r:r.get("body"),s=typeof r=="string"?r:r.isStyling,o=t.get("_id");if(s){var a=n(e.contentWindow.document).find('link[rel="stylesheet"][href^="/document/"]'),f=a.length>0?a.attr("href").split("?")[0]:"",l=f+"?"+(new Date).getTime();a.length<1&&(a=n(e.contentWindow.document).find("link"),l="/document/"+o+".css"),a.attr("href",l)}else e.contentWindow.remark&&e.contentWindow.remark.loadFromString(u(i))}})});